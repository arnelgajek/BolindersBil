@model Vehicle

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Admin - AddNewVehicle";
}

<div style="text-align:center; margin-top:20px; margin-bottom:25px">
    <h2><strong>Add Vehicle</strong></h2>
</div>
<hr />

<div>
    <form asp-action="AddNewVehicle" id="addNewVehicleForm" enctype="multipart/form-data" class="form-horizontal">

        <div class="form-group">
            <label asp-for="RegNr" class="control-label col-sm-2"><strong>Registreringsnummer:</strong></label>
            <div class="col-sm-10">
                <input asp-for="RegNr" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Brand" class="control-label col-sm-2"><strong>Märke:</strong></label>
            <div class="col-sm-10">
                <input asp-for="Brand" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Model" class="control-label col-sm-2"><strong>Modell:</strong></label>
            <div class="col-sm-10">
                <input asp-for="Model" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label asp-for="ModelDescription" class="control-label col-sm-2"><strong>Modellbeskrivning:</strong></label>
            <div class="col-sm-10">
                <textarea asp-for="ModelDescription" class="form-control"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Year" class="control-label col-sm-2"><strong>Årsmodell:</strong></label>
            <div class="col-sm-10">
                <select asp-for="Year" class="form-control" id="">
                    <option selected>Välj</option>
                    @foreach (var year in ViewBag.vehicleYearOptions)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Kilometer" class="control-label col-sm-2"><strong>Kilometer:</strong></label>
            <div class="col-sm-10">
                <input asp-for="Kilometer" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Price" class="control-label col-sm-2"><strong>Pris:</strong></label>
            <div class="col-sm-10">
                <input asp-for="Price" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Body" class="control-label col-sm-2"><strong>Karosstyp:</strong></label>
            <div class="col-sm-10">
                <select asp-for="Body" class="form-control" id="">
                    <option selected>Välj</option>
                    @foreach (var bodyType in ViewBag.bodyTypes)
                    {
                        <option value="@bodyType">@bodyType</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Color" class="control-label col-sm-2"><strong>Färg:</strong></label>
            <div class="col-sm-10">
                <input asp-for="Color" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Gearbox" class="control-label col-sm-2"><strong>Växellådstyp:</strong></label>
            <div class="col-sm-10">
                <select asp-for="Gearbox" class="form-control" id="">
                    <option selected>Välj</option>
                    @foreach (var gear in ViewBag.gears)
                    {
                        <option value="@gear">@gear</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Fuel" class="control-label col-sm-2"><strong>Bränsletyp:</strong></label>
            <div class="col-sm-10">
                <select asp-for="Fuel" class="form-control" id="">
                    <option selected>Välj</option>
                    @foreach (var fuelType in ViewBag.fuelTypes)
                    {
                        <option value="@fuelType">@fuelType</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Horsepower" class="control-label col-sm-2"><strong>Hästkrafter:</strong></label>
            <div class="col-sm-10">
                <input asp-for="Horsepower" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            @*<label asp-for="Used" class="control-label col-sm-2"><strong>Sälj som begagnad?:</strong></label>*@
            <div class="col-sm-10">
                <label class="checkbox-inline"><strong>Sälj som begagnad?:</strong>&nbsp;&nbsp;&nbsp;&nbsp;<input asp-for="Used" type="checkbox" id="usedCheckbox" value="false"></label>
                @*<label class="checkbox-inline"><input asp-for="Used" type="checkbox" value="false">  Nej</label>*@
            </div>
        </div>

        <div class="form-group">
            @*<label asp-for="Leasable" class="control-label col-sm-4"><strong>Leasbar för företag:</strong></label>*@
            <div class="col-sm-10">
                <label class="checkbox-inline"><strong>Leasbar för företag?:</strong>&nbsp;&nbsp;&nbsp;&nbsp;<input asp-for="Leasable" type="checkbox" id="leasableCheckbox" value="false"></label>
                @*<label class="checkbox-inline"><input asp-for="Leasable" type="checkbox" value="false">  Nej</label>*@
            </div>
        </div>

        <div class="form-group">
            <label asp-for="Office" class="control-label col-sm-2"><strong>Anläggning:</strong></label>
            <div class="col-sm-10">
                <select asp-for="Office" class="form-control" id="">
                    <option selected>Välj</option>
                    @foreach (var office in ViewBag.offices)
                    {
                        <option value="@office">@office</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="images" class="control-label col-sm-2"><strong>Bilder:</strong></label>
            <div class="col-sm-4">
                <input type="file" id="images" name="images" class="form-control-file" multiple style="display:none">
                <button class="btn" id="selectFilesBtn">Välj filer</button>
                <div class="form-group" id="filePreviews"></div>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="VehicleAttribute" class="control-label col-sm-2"><strong>Pipe-separerad attributlista:</strong></label>
            <div class="col-sm-10">
                <input asp-for="VehicleAttribute" class="form-control" />
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-10">
                <button class="btn btn-primary" type="submit">Add Vehicle</button>
                <a asp-controller="Vehicle" asp-action="Admin" class="btn btn-secondary">Cancel</a>
            </div>
        </div>

    </form>
</div>

<script src="~/js/site.min.js"></script>
<script>
    var formUtils = {
        files: [],
        buildPreview: function (dataUrl) {
            var html = ['<img src="' + dataUrl + '" class="img-thumbnail">'];
            var button = ['<a class="btn btn-warning btn-sm">Ta bort</a>'];
            var theDiv = ['<div class="imageThumbnailPreview">'+ html + button + '</div>'];
            $('#filePreviews').append(theDiv);
        },
        removeImage: function (index) {
            formUtils.files.splice(index, 1);
            console.log(formUtils.files);
        }
    };

    $(document).ready(function () {
        
        $('#selectFilesBtn').click(function (e) {
            e.preventDefault();
            $('#images').trigger('click');
        });

        $(document).on('click', 'div.imageThumbnailPreview', function () {
            formUtils.removeImage($(this).index());
            $(this).remove();
        });


        $(document).on('change', '#usedCheckbox', function () {
            if ($(this).is(':checked')) {
                $(this).attr('value', 'true');
                //console.log($(this).val());
            } else {
                $(this).attr('value', 'false');
                //console.log($(this).val());
            }
        });
        $(document).on('change', '#leasableCheckbox', function () {
            if ($(this).is(':checked')) {
                $(this).attr('value', 'true');
                //console.log($(this).val());
            } else {
                $(this).attr('value', 'false');
                //console.log($(this).val());
            }
        });
        

        if ($('#addNewVehicleForm').length > 0) {
            $("#images").on("change", function (event) {
                formUtils.files = [];
                var files = event.originalEvent.target.files;
                $(files).each(function (i, file) {
                    var reader = new FileReader();
                    reader.addEventListener("load", function () {
                        formUtils.files.push(file);
                        var dataUrl = reader.result;
                        formUtils.buildPreview(dataUrl);
                    }, false);
                    reader.readAsDataURL(file);
                });
            });

            $('#addNewVehicleForm').submit(function (e) {
                e.preventDefault();
                $('#images').remove();
                var formData = new FormData();

                
                $('#addNewVehicleForm textarea').each(function () {
                    formData.append($(this).attr('name'), $(this).val());
                });
                $('#addNewVehicleForm select').each(function () {
                    formData.append($(this).attr('name'), $(this).val());
                });
                $('#addNewVehicleForm input').each(function () {
                    formData.append($(this).attr('name'), $(this).val());
                });
                $(formUtils.files).each(function (i, file) {
                    formData.append('images[' + i + ']', formUtils.files[i]);
                });

                $.ajax({
                    url: $('#addNewVehicleForm').attr('action'),
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });

            });
        }
    });
    
</script>